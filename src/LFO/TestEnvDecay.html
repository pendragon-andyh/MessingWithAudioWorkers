<html>
  <head>
    <title>Testing Envelope - Decay</title>
  </head>
  <body>
    <h1>Decay Rate slider position => Decay speed</h1>
    <table border="1">
      <thead>
        <th>Slider</th>
        <th>Time to 0.5</th>
        <th>Time to 1</th>
        <th>Decay factor</th>
      </thead>
      <tbody id="results">
      </tbody>
    </table>
    <script type="module">
      import { Envelope } from './Processors/Envelope.js';

      //alert("hello");

      let results=document.getElementById('results');
      appendResult(0.0, results);
      appendResult(0.5, results);
      appendResult(1.0, results);
      appendResult(1.5, results);
      appendResult(2.0, results);
      appendResult(2.5, results);
      appendResult(3.0, results);
      appendResult(3.5, results);
      appendResult(4.0, results);
      appendResult(4.5, results);
      appendResult(5.0, results);
      appendResult(5.5, results);
      appendResult(6.0, results);
      appendResult(6.5, results);
      appendResult(7.0, results);
      appendResult(7.5, results);
      appendResult(8.0, results);
      appendResult(8.5, results);
      appendResult(9.0, results);
      appendResult(9.5, results);
      appendResult(10.0, results);

      function appendResult(sliderPos, results){
        let result = calcForSliderPosition(sliderPos);
        let row=document.createElement('tr');
        row.innerHTML=`<td>${sliderPos}</td><td>${result.timeToHalf.toFixed(6)} seconds</td><td>${result.timeToFull.toFixed(6)} seconds</td><td>${result.decayFactor.toFixed(8)}</td>`;
        results.append(row);
      }

      function calcForSliderPosition(sliderPos){
        const sampleRate=44100;

        let env=new Envelope(sampleRate);
        env.setDecayRate(sliderPos);
        env.phase=2;
        env.value=1;
        let quantumCountA=0, quantumCountB=0;
        while (env.process() > 0 && env.phase === 2){
          quantumCountB++;
          if (env.value>0.5){
            quantumCountA++;
          }
        }

        return { timeToHalf: quantumCountA/sampleRate, timeToFull: quantumCountB/sampleRate, decayFactor: env.decayFactor };
      }
    </script>
  </body>
</html>
